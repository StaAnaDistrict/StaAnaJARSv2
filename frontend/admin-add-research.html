<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Add New Research - Administrator Dashboard - Sta. Ana JARS üè∫</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="stylesheet" href="css/admin-add-research.css">
</head>
<body>
  <nav class="navbar">
    <a href="index.html" class="navbar-logo-link"><img src="images/StaAnaJARSLogo.png" alt="Logo" class="navbar-logo"></a>
    <ul class="navbar-links" id="navbarLinks">
      <li><a href="index.html" class="navbar-link">Home</a></li>
      <li><a href="about.html" class="navbar-link">About</a></li>
      <li class="navbar-dropdown-parent">
        <a href="#" class="navbar-link navbar-dropdown-label" tabindex="0">Journal Issues</a>
        <ul class="navbar-dropdown">
          <li><a href="action-research/school-based.html" class="navbar-dropdown-link">School-Based</a></li>
          <li><a href="action-research/district-based.html" class="navbar-dropdown-link">District-Based</a></li>
          <li><a href="action-research/division-based.html" class="navbar-dropdown-link">Division-Based</a></li>
          <li><a href="action-research/berf-grantee.html" class="navbar-dropdown-link">BERF Grantee</a></li>
        </ul>
      </li>
      <li><a href="submit-a-study.html" class="navbar-link">Submit a Study</a></li>
      <li><a href="editorial.html" class="navbar-link">Editorial Board</a></li>
    </ul>
    <div class="navbar-hamburger" id="navbarHamburger" aria-label="Open navigation" tabindex="0">
      <span></span>
      <span></span>
      <span></span>
    </div>
  </nav>

  <section class="form-section">
    <div class="form-container">
      <h2 class="form-title">Add New Research</h2>
      <p class="form-subtitle">Create a new action research study</p>
      
      <div class="form-card">
        <form id="addResearchForm">
          <div class="form-group">
            <label for="researchCategory" class="form-label">Research Category *</label>
            <select id="researchCategory" name="researchCategory" class="form-select" required>
              <option value="">Select Research Category</option>
              <option value="School-Based">School-Based</option>
              <option value="District-Based">District-Based</option>
              <option value="Division-Based">Division-Based</option>
              <option value="BERF-Grantee">BERF-Grantee</option>
            </select>
          </div>

          <div class="form-group">
            <label for="researchTitle" class="form-label">Research Title *</label>
            <textarea id="researchTitle" name="researchTitle" class="form-textarea large" required placeholder="Enter the complete research title"></textarea>
          </div>

          <div class="form-group">
            <label for="researcherName" class="form-label">Name of Researcher(s) *</label>
            <div class="researchers-section">
              <div class="researcher-selection">
                <select id="researcherSelect" class="form-select">
                  <option value="">Select existing researcher or add new...</option>
                </select>
                <button type="button" class="btn btn-secondary" id="addResearcherBtn" style="margin-top: 0.5rem;">Add New Researcher</button>
              </div>
              <div class="selected-researchers" id="selectedResearchers">
                <!-- Selected researchers will be displayed here -->
              </div>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="completionYear" class="form-label">Completion Year *</label>
              <input type="number" id="completionYear" name="completionYear" class="form-input" min="2000" max="2030" required>
            </div>
            <div class="form-group">
              <label for="completionMonth" class="form-label">Completion Month *</label>
              <select id="completionMonth" name="completionMonth" class="form-select" required>
                <option value="">Select Month</option>
                <option value="January">January</option>
                <option value="February">February</option>
                <option value="March">March</option>
                <option value="April">April</option>
                <option value="May">May</option>
                <option value="June">June</option>
                <option value="July">July</option>
                <option value="August">August</option>
                <option value="September">September</option>
                <option value="October">October</option>
                <option value="November">November</option>
                <option value="December">December</option>
              </select>
            </div>
          </div>

          <div class="form-group">
            <label for="abstract" class="form-label">Abstract *</label>
            <textarea id="abstract" name="abstract" class="form-textarea large" required placeholder="Enter the research abstract (maximum 750 words)" maxlength="4000"></textarea>
            <div class="word-count" id="abstractWordCount">0 / 750 words</div>
          </div>

          <div class="form-group">
            <label for="focusCategory" class="form-label">Category *</label>
            <select id="focusCategory" name="focusCategory" class="form-select" required>
              <option value="">Select Category</option>
              <option value="Teaching and Learning">Teaching and Learning</option>
              <option value="Child Protection">Child Protection</option>
              <option value="Human Resource Development">Human Resource Development</option>
              <option value="Governance">Governance</option>
            </select>
          </div>

          <div class="form-group">
            <label for="onlinePublicationDate" class="form-label">Online Publication Date *</label>
            <input type="date" id="onlinePublicationDate" name="onlinePublicationDate" class="form-input" required>
          </div>

          <div class="form-group">
            <label for="keywords" class="form-label">Keywords</label>
            <textarea id="keywords" name="keywords" class="form-textarea" placeholder="Enter keywords separated by commas"></textarea>
          </div>

          <div class="form-group">
            <label for="journalIssue" class="form-label">Journal Issue *</label>
            <input type="number" id="journalIssue" name="journalIssue" class="form-input" min="1" required>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="volumeIssue" class="form-label">Volume/Issue</label>
              <input type="text" id="volumeIssue" name="volumeIssue" class="form-input" placeholder="e.g., Vol. 1, No. 2">
            </div>
            <div class="form-group">
              <label for="pages" class="form-label">Pages</label>
              <input type="text" id="pages" name="pages" class="form-input" placeholder="e.g., 15-25">
            </div>
          </div>

          <div class="form-group">
            <label for="publishedIn" class="form-label">Published In</label>
            <input type="text" id="publishedIn" name="publishedIn" class="form-input auto-generated" readonly>
          </div>

          <div class="form-group">
            <label for="publishedOn" class="form-label">Published On</label>
            <input type="text" id="publishedOn" name="publishedOn" class="form-input auto-generated" readonly>
          </div>

          <div class="form-group">
            <label for="doi" class="form-label">DOI</label>
            <input type="text" id="doi" name="doi" class="form-input" placeholder="Enter DOI if available">
          </div>

          <div class="form-group">
            <label for="researchUrl" class="form-label">PDF URL</label>
            <input type="url" id="researchUrl" name="researchUrl" class="form-input" placeholder="Enter URL to the PDF file">
          </div>

          <div id="errorMessage" class="error-message"></div>
          <div id="successMessage" class="success-message"></div>

          <div class="form-actions">
            <button type="submit" class="btn btn-primary" id="saveBtn">Save Research</button>
            <a href="admin-dashboard.html" class="btn btn-secondary">Cancel</a>
          </div>
        </form>
      </div>
    </div>
  </section>

  <footer class="site-footer">
    <div class="footer-content">
      <div class="footer-copyright">¬© 2025 Sta. Ana JARS. All rights reserved. Developed by Mr. Wedzmer Munjilul</div>
      <div class="footer-links">
        <a href="privacy-policy.html" class="footer-link">Privacy Policy</a>
        <span class="footer-sep">|</span>
        <a href="terms-of-use.html" class="footer-link">Terms of Use</a>
        <span class="footer-sep">|</span>
        <a href="site-map.html" class="footer-link">Site Map</a>
      </div>
    </div>
  </footer>

  <script>
    // Check authentication
    window.addEventListener('load', function() {
      const isLoggedIn = sessionStorage.getItem('adminLoggedIn');
      if (isLoggedIn !== 'true') {
        window.location.href = 'admin-login.html';
        return;
      }
      
      // Load existing researchers
      loadExistingResearchers();
    });

    // Load existing researchers
    async function loadExistingResearchers() {
      try {
        console.log('üîÑ Loading researchers...');
        
        const response = await fetch('/api/researchers?limit=100');
        if (response.ok) {
          const data = await response.json();
          const select = document.getElementById('researcherSelect');
          
          // Clear existing options except the first one
          select.innerHTML = '<option value="">Select existing researcher or add new...</option>';
          
          if (data.researchers && data.researchers.length > 0) {
            data.researchers.forEach(researcher => {
              const option = document.createElement('option');
              option.value = researcher.profile_id;
              option.textContent = `${researcher.last_name}, ${researcher.first_name} ${researcher.middle_name || ''}`.trim();
              select.appendChild(option);
            });
            console.log(`‚úÖ Loaded ${data.researchers.length} researchers successfully`);
          } else {
            console.log('‚ÑπÔ∏è No researchers found in database');
            select.innerHTML = '<option value="">No researchers found - add new researcher</option>';
          }
        } else {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
      } catch (error) {
        console.error('‚ùå Error loading researchers:', error.message);
        const select = document.getElementById('researcherSelect');
        select.innerHTML = '<option value="">Error loading researchers - please try again</option>';
      }
    }

    // Selected researchers array
    let selectedResearchers = [];

    // Handle researcher selection
    document.getElementById('researcherSelect').addEventListener('change', function() {
      const selectedId = this.value;
      if (selectedId && selectedResearchers.length < 3) {
        const selectedOption = this.options[this.selectedIndex];
        const researcherName = selectedOption.textContent;
        
        // Check if already selected
        if (!selectedResearchers.find(r => r.id === selectedId)) {
          selectedResearchers.push({
            id: selectedId,
            name: researcherName,
            isExisting: true
          });
          updateSelectedResearchersDisplay();
        }
        
        // Reset selection
        this.value = '';
      }
    });

    // Handle add new researcher button
    document.getElementById('addResearcherBtn').addEventListener('click', function() {
      if (selectedResearchers.length < 3) {
        // Set flag to indicate this was opened from research form
        sessionStorage.setItem('fromResearchForm', 'true');
        // Open new researcher form in a modal or redirect
        window.open('admin-add-researcher.html', '_blank');
      }
    });

    // Update selected researchers display
    function updateSelectedResearchersDisplay() {
      const container = document.getElementById('selectedResearchers');
      container.innerHTML = '';
      
      selectedResearchers.forEach((researcher, index) => {
        const div = document.createElement('div');
        div.className = 'selected-researcher';
        div.innerHTML = `
          <div class="researcher-info">
            <span class="researcher-name">${researcher.name}</span>
            ${index === 0 ? '<span class="lead-author-badge">Lead Author</span>' : ''}
          </div>
          <button type="button" class="remove-researcher-btn" onclick="removeResearcher(${index})">Remove</button>
        `;
        container.appendChild(div);
      });
    }

    // Remove researcher
    function removeResearcher(index) {
      selectedResearchers.splice(index, 1);
      updateSelectedResearchersDisplay();
    }

    // Word count for abstract
    const abstractTextarea = document.getElementById('abstract');
    const abstractWordCount = document.getElementById('abstractWordCount');

    abstractTextarea.addEventListener('input', function() {
      const words = this.value.trim().split(/\s+/).filter(word => word.length > 0);
      const wordCount = words.length;
      abstractWordCount.textContent = `${wordCount} / 750 words`;
      
      if (wordCount > 700) {
        abstractWordCount.className = 'word-count warning';
      } else if (wordCount > 750) {
        abstractWordCount.className = 'word-count error';
      } else {
        abstractWordCount.className = 'word-count';
      }
    });

    // Auto-generate Published In and Published On fields
    function updateAutoGeneratedFields() {
      const researchCategory = document.getElementById('researchCategory').value;
      const completionMonth = document.getElementById('completionMonth').value;
      const completionYear = document.getElementById('completionYear').value;
      const journalIssue = document.getElementById('journalIssue').value;
      const onlinePublicationDate = document.getElementById('onlinePublicationDate').value;

      // Published In
      if (researchCategory && completionMonth && completionYear) {
        document.getElementById('publishedIn').value = `${researchCategory} Action Research. Completed in ${completionMonth} of ${completionYear}.`;
      }

      // Published On
      if (researchCategory && journalIssue && onlinePublicationDate) {
        const date = new Date(onlinePublicationDate);
        const formattedDate = date.toLocaleDateString('en-US', {
          year: 'numeric',
          month: 'long',
          day: 'numeric'
        });
        document.getElementById('publishedOn').value = `${researchCategory} Action Research Sta. Ana JARS Journal Issue ${journalIssue}, ${formattedDate}`;
      }
    }

    // Add event listeners for auto-generation
    document.getElementById('researchCategory').addEventListener('change', updateAutoGeneratedFields);
    document.getElementById('completionMonth').addEventListener('change', updateAutoGeneratedFields);
    document.getElementById('completionYear').addEventListener('input', updateAutoGeneratedFields);
    document.getElementById('journalIssue').addEventListener('input', updateAutoGeneratedFields);
    document.getElementById('onlinePublicationDate').addEventListener('change', updateAutoGeneratedFields);

    // Form submission
    document.getElementById('addResearchForm').addEventListener('submit', async function(e) {
      e.preventDefault();

      const saveBtn = document.getElementById('saveBtn');
      const errorMessage = document.getElementById('errorMessage');
      const successMessage = document.getElementById('successMessage');

      // Clear messages
      errorMessage.style.display = 'none';
      successMessage.style.display = 'none';

      // Disable button
      saveBtn.disabled = true;
      saveBtn.textContent = 'Saving...';

      try {
        // Validate that at least one researcher is selected
        if (selectedResearchers.length === 0) {
          throw new Error('At least one researcher must be selected');
        }

        // Collect form data
        const formData = new FormData(this);
        const researchData = {
          research_title: formData.get('researchTitle'),
          abstract: formData.get('abstract'),
          keywords: formData.get('keywords'),
          completion_year: parseInt(formData.get('completionYear')),
          completion_month: formData.get('completionMonth'),
          online_publication_date: formData.get('onlinePublicationDate'),
          journal_issue_number: parseInt(formData.get('journalIssue')),
          volume_issue: formData.get('volumeIssue'),
          pages: formData.get('pages'),
          doi: formData.get('doi'),
          research_url: formData.get('researchUrl'),
          action_research_type_id: getResearchTypeId(formData.get('researchCategory')),
          research_focus_category_id: getFocusCategoryId(formData.get('focusCategory')),
          published_in: document.getElementById('publishedIn').value,
          published_on: document.getElementById('publishedOn').value,
          authors: selectedResearchers.map((researcher, index) => ({
            profile_id: researcher.id,
            is_lead_author: index === 0,
            author_order: index + 1
          }))
        };

        // Send to API
        const response = await fetch('/api/researches', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(researchData)
        });

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
        }

        const result = await response.json();
        
        successMessage.textContent = 'Research added successfully!';
        successMessage.style.display = 'block';
        
        // Reset form after short delay
        setTimeout(() => {
          this.reset();
          document.getElementById('publishedIn').value = '';
          document.getElementById('publishedOn').value = '';
          abstractWordCount.textContent = '0 / 750 words';
          abstractWordCount.className = 'word-count';
          window.location.href = 'admin-dashboard.html';
        }, 2000);

      } catch (error) {
        console.error('Error adding research:', error);
        errorMessage.textContent = 'Error adding research. Please try again.';
        errorMessage.style.display = 'block';
      } finally {
        // Re-enable button
        saveBtn.disabled = false;
        saveBtn.textContent = 'Save Research';
      }
    });

    // Helper functions for category IDs
    function getResearchTypeId(categoryName) {
      const typeMap = {
        'School-Based': 1,
        'District-Based': 2,
        'Division-Based': 3,
        'BERF-Grantee': 4
      };
      return typeMap[categoryName] || 1;
    }

    function getFocusCategoryId(categoryName) {
      const categoryMap = {
        'Teaching and Learning': 1,
        'Child Protection': 2,
        'Human Resource Development': 3,
        'Governance': 4
      };
      return categoryMap[categoryName] || 1;
    }

    // Hamburger menu toggle
    const hamburger = document.getElementById('navbarHamburger');
    const links = document.getElementById('navbarLinks');
    hamburger.addEventListener('click', () => {
      links.classList.toggle('active');
    });
    hamburger.addEventListener('keypress', (e) => {
      if (e.key === 'Enter' || e.key === ' ') {
        links.classList.toggle('active');
      }
    });

    // Dropdown for Journal Issues
    const dropdownParent = document.querySelector('.navbar-dropdown-parent');
    const dropdownLabel = dropdownParent.querySelector('.navbar-dropdown-label');
    
    function isMobile() {
      return window.innerWidth <= 768;
    }
    
    dropdownLabel.addEventListener('click', function(e) {
      if (isMobile()) {
        e.preventDefault();
        dropdownParent.classList.toggle('open');
      }
    });
    
    dropdownLabel.addEventListener('keypress', function(e) {
      if (isMobile() && (e.key === 'Enter' || e.key === ' ')) {
        e.preventDefault();
        dropdownParent.classList.toggle('open');
      }
    });
    
    // Hide dropdown on resize
    window.addEventListener('resize', function() {
      dropdownParent.classList.remove('open');
    });
  </script>
</body>
</html> 